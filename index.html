<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#0f172a">
    <title>Noosa Navigator | Holiday Concierge</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&family=Playfair+Display:ital,wght@0,400;0,600;0,700;1,400&display=swap" rel="stylesheet">
    
    <!-- Babel for in-browser compilation -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
      :root { --noosa-blue: #0ea5e9; --noosa-navy: #0f172a; --noosa-sand: #fdfcfb; }
      body { font-family: 'Outfit', sans-serif; background-color: var(--noosa-sand); color: var(--noosa-navy); margin: 0; padding: 0; overflow: hidden; -webkit-tap-highlight-color: transparent; }
      #root { height: 100vh; display: flex; flex-direction: column; }
      .no-scrollbar::-webkit-scrollbar { display: none; }
      .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
      .glass { background: rgba(255, 255, 255, 0.85); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); border-bottom: 1px solid rgba(255,255,255,0.5); }
      @keyframes message-enter { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
      .message-enter { animation: message-enter 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
      @keyframes pulse-soft { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
      .animate-pulse-soft { animation: pulse-soft 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
    </style>

    <!-- Global Error Handler -->
    <script>
      window.process = { env: { NODE_ENV: 'production' } };
      window.onerror = function(msg, url, line, col, error) {
        // Ignore resize/observer errors which are benign
        if (msg.includes('ResizeObserver')) return false;
        
        const root = document.getElementById('root');
        if (root && (root.innerText.includes('Initializing') || root.innerText.includes('Establishing'))) {
          root.innerHTML = `
            <div style="padding: 2rem; text-align: center; color: #ef4444; font-family: sans-serif;">
              <h2 style="font-size: 1.5rem; margin-bottom: 1rem;">Application Error</h2>
              <p style="margin-bottom: 1rem;">${msg}</p>
              <button onclick="location.reload()" style="background:#0f172a; color:white; padding: 10px 20px; border-radius: 99px; border:none;">Retry</button>
            </div>
          `;
        }
        return false;
      };
    </script>
<script type="importmap">
{
  "imports": {
    "@google/genai": "https://esm.sh/@google/genai@^1.34.0",
    "react": "https://esm.sh/react@^19.2.3",
    "lucide-react": "https://esm.sh/lucide-react@^0.562.0",
    "react/": "https://esm.sh/react@^19.2.3/"
  }
}
</script>
</head>
<body>
    <div id="root">
        <!-- Initial Loading State -->
        <div class="flex-1 flex flex-col items-center justify-center p-6 text-center bg-[#fdfcfb]">
             <div class="w-16 h-16 bg-slate-900 rounded-[1.5rem] flex items-center justify-center text-white shadow-xl mb-6">
                <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><polygon points="16.24 7.76 14.12 14.12 7.76 16.24 9.88 9.88 16.24 7.76"></polygon></svg>
             </div>
             <h2 style="font-family: 'Playfair Display', serif;" class="text-2xl font-bold text-slate-900 mb-2">Noosa Navigator</h2>
             <p class="text-slate-400 text-[10px] font-bold uppercase tracking-[0.3em] animate-pulse-soft">Establishing Connection...</p>
        </div>
    </div>

    <!-- MAIN APPLICATION LOGIC -->
    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useRef } from 'https://esm.sh/react@18.2.0';
        import { createRoot } from 'https://esm.sh/react-dom@18.2.0/client';
        import { GoogleGenAI } from 'https://esm.sh/@google/genai@latest';

        // --- ICONS (SVG) ---
        const Icons = {
            Compass: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><polygon points="16.24 7.76 14.12 14.12 7.76 16.24 9.88 9.88 16.24 7.76"/></svg>,
            User: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>,
            Send: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>,
            MapPin: () => <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/></svg>,
            ExternalLink: () => <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" y1="14" x2="21" y2="3"/></svg>,
            Sparkles: () => <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"/></svg>,
            Key: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="7.5" cy="15.5" r="5.5"/><path d="m21 2-9.6 9.6"/><path d="m15.5 7.5 3 3L22 7l-3-3"/></svg>
        };

        // --- CONSTANTS ---
        const NOOSA_COORDS = { latitude: -26.3945, longitude: 153.0864 };
        const SYSTEM_PROMPT = `You are the "Noosa Navigator," an elite local concierge for Noosa, QLD. 
        Expertise: Hastings Street, Noosaville, Sunshine Beach, Hinterland.
        Rules:
        1. Concise, elite tone. Max 3 recommendations.
        2. ALWAYS use googleSearch and googleMaps tools to find real venues.
        3. Response format: **Name**: Description.
        `;

        // --- API SERVICE ---
        const generateResponse = async (prompt, history, apiKey, locality) => {
            const ai = new GoogleGenAI({ apiKey });
            const contents = history.map(msg => ({
                role: msg.role === 'user' ? 'user' : 'model',
                parts: [{ text: msg.text }]
            }));
            
            // Add current prompt with context
            const contextPrompt = locality === 'All Noosa' ? prompt : `[Context: ${locality}] ${prompt}`;
            contents.push({ role: 'user', parts: [{ text: contextPrompt }] });

            const result = await ai.models.generateContent({
                model: 'gemini-2.5-flash',
                contents: contents,
                config: {
                    systemInstruction: SYSTEM_PROMPT,
                    temperature: 0.2,
                    tools: [{ googleSearch: {} }, { googleMaps: {} }],
                    toolConfig: { retrievalConfig: { latLng: NOOSA_COORDS } }
                }
            });
            
            return {
                text: result.text || "I couldn't find that information right now.",
                chunks: result.candidates?.[0]?.groundingMetadata?.groundingChunks || []
            };
        };

        // --- COMPONENTS ---

        const ChatMessage = ({ msg }) => {
            const isUser = msg.role === 'user';
            
            // Process links from grounding chunks
            const links = (msg.chunks || []).reduce((acc, chunk) => {
                const uri = chunk.maps?.uri || chunk.web?.uri;
                const title = chunk.maps?.title || chunk.web?.title;
                if (uri && title && !acc.some(l => l.uri === uri)) {
                    acc.push({ uri, title, type: chunk.maps ? 'Map' : 'Web' });
                }
                return acc;
            }, []).slice(0, 3);

            // Text formatting
            const renderText = (text) => text.split('\n').map((line, i) => {
                const parts = line.split(/(\*\*.*?\*\*)/g);
                return (
                    <div key={i} className="mb-1.5 last:mb-0">
                        {parts.map((part, j) => 
                            part.startsWith('**') ? <strong key={j} className="text-slate-900 font-bold">{part.slice(2, -2)}</strong> : part
                        )}
                    </div>
                );
            });

            return (
                <div className={`flex w-full mb-6 message-enter ${isUser ? 'justify-end' : 'justify-start'}`}>
                    <div className={`flex max-w-[90%] md:max-w-[80%] gap-3 ${isUser ? 'flex-row-reverse' : 'flex-row'}`}>
                        <div className={`flex-shrink-0 w-8 h-8 rounded-full flex items-center justify-center shadow-md ${isUser ? 'bg-slate-800 text-white' : 'bg-sky-500 text-white'}`}>
                            {isUser ? <Icons.User /> : <Icons.Compass />}
                        </div>
                        <div className="flex flex-col min-w-0">
                            <div className={`px-5 py-3.5 rounded-2xl shadow-sm text-sm leading-relaxed ${
                                isUser ? 'bg-slate-900 text-slate-50 rounded-tr-none' : 'glass text-slate-800 rounded-tl-none border border-white'
                            }`}>
                                {renderText(msg.text)}
                            </div>
                            {!isUser && links.length > 0 && (
                                <div className="mt-2 flex flex-wrap gap-2">
                                    {links.map((link, idx) => (
                                        <a key={idx} href={link.uri} target="_blank" className="flex items-center gap-1.5 px-3 py-1.5 bg-white rounded-full text-xs font-semibold text-slate-700 shadow-sm border border-slate-100 hover:bg-sky-50 transition-colors no-underline">
                                            {link.title}
                                            {link.type === 'Map' ? <Icons.MapPin /> : <Icons.ExternalLink />}
                                        </a>
                                    ))}
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        const APIKeyModal = ({ onSave }) => {
            const [key, setKey] = useState('');
            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center bg-slate-900/40 backdrop-blur-sm p-4">
                    <div className="bg-white rounded-3xl p-8 max-w-sm w-full shadow-2xl text-center">
                        <div className="w-16 h-16 bg-slate-900 rounded-2xl flex items-center justify-center text-white mx-auto mb-6 shadow-lg">
                            <Icons.Key />
                        </div>
                        <h2 className="text-xl font-serif font-bold text-slate-900 mb-2">Access Concierge</h2>
                        <p className="text-sm text-slate-500 mb-6">Enter your Google Gemini API Key to activate the Noosa Navigator.</p>
                        <input 
                            type="password" 
                            placeholder="Paste API Key here..." 
                            className="w-full px-4 py-3 rounded-xl bg-slate-50 border border-slate-200 mb-4 focus:outline-none focus:ring-2 focus:ring-sky-500 text-sm"
                            value={key}
                            onChange={e => setKey(e.target.value)}
                        />
                        <button 
                            onClick={() => key.trim() && onSave(key.trim())}
                            disabled={!key.trim()}
                            className="w-full py-3 bg-slate-900 text-white rounded-xl font-bold text-sm shadow-lg disabled:opacity-50 hover:scale-[1.02] transition-transform"
                        >
                            Connect
                        </button>
                        <p className="mt-4 text-[10px] text-slate-400">
                            <a href="https://aistudio.google.com/app/apikey" target="_blank" className="underline hover:text-slate-600">Get a key from Google AI Studio</a>
                        </p>
                    </div>
                </div>
            );
        };

        const App = () => {
            const [apiKey, setApiKey] = useState(() => localStorage.getItem('noosa_api_key') || '');
            const [messages, setMessages] = useState([{
                id: 'welcome', role: 'model', text: "Welcome to Noosa. ðŸŒŠ I am your expert concierge. Ask me about dining, surf spots, or hidden gems."
            }]);
            const [input, setInput] = useState('');
            const [loading, setLoading] = useState(false);
            const [locality, setLocality] = useState('All Noosa');
            const bottomRef = useRef(null);

            useEffect(() => {
                bottomRef.current?.scrollIntoView({ behavior: 'smooth' });
            }, [messages, loading]);

            const handleSend = async () => {
                if (!input.trim() || loading) return;
                const userText = input;
                setInput('');
                setLoading(true);
                
                // Optimistic UI
                const history = [...messages];
                setMessages(prev => [...prev, { id: Date.now(), role: 'user', text: userText }]);

                try {
                    const response = await generateResponse(userText, history, apiKey, locality);
                    setMessages(prev => [...prev, { 
                        id: Date.now() + 1, 
                        role: 'model', 
                        text: response.text, 
                        chunks: response.chunks 
                    }]);
                } catch (error) {
                    console.error(error);
                    const isAuthError = error.toString().includes('403') || error.toString().includes('key');
                    setMessages(prev => [...prev, { 
                        id: Date.now() + 1, 
                        role: 'model', 
                        text: isAuthError ? "Authentication failed. Please check your API Key." : "I'm having trouble connecting to the network. Please try again." 
                    }]);
                    if (isAuthError) {
                        localStorage.removeItem('noosa_api_key');
                        setApiKey('');
                    }
                } finally {
                    setLoading(false);
                }
            };

            if (!apiKey) {
                return <APIKeyModal onSave={(key) => { localStorage.setItem('noosa_api_key', key); setApiKey(key); }} />;
            }

            const localities = ['All Noosa', 'Hastings St', 'Noosaville', 'Sunshine Beach', 'Hinterland'];

            return (
                <div className="flex flex-col h-screen bg-[#fdfcfb]">
                    {/* Header */}
                    <div className="glass sticky top-0 z-20 px-4 py-3 shadow-sm">
                        <div className="max-w-3xl mx-auto">
                            <div className="flex items-center gap-3 mb-3">
                                <div className="w-10 h-10 bg-slate-900 rounded-xl flex items-center justify-center text-white shadow-md">
                                    <Icons.Compass />
                                </div>
                                <div>
                                    <h1 className="font-serif text-lg font-bold text-slate-900 leading-none">Noosa</h1>
                                    <p className="text-[10px] font-bold uppercase tracking-widest text-sky-600 mt-1">Concierge</p>
                                </div>
                                <div className="flex-1"></div>
                                <button onClick={() => { if(confirm('Reset Key?')) { localStorage.removeItem('noosa_api_key'); setApiKey(''); }}} className="text-[10px] text-slate-400 underline">Reset Key</button>
                            </div>
                            <div className="flex gap-2 overflow-x-auto no-scrollbar pb-1">
                                {localities.map(loc => (
                                    <button 
                                        key={loc} 
                                        onClick={() => setLocality(loc)}
                                        className={`flex-shrink-0 px-3 py-1.5 rounded-full text-[10px] font-bold uppercase tracking-wide transition-all ${
                                            locality === loc 
                                            ? 'bg-slate-900 text-white shadow-md' 
                                            : 'bg-white text-slate-500 border border-slate-200'
                                        }`}
                                    >
                                        {loc}
                                    </button>
                                ))}
                            </div>
                        </div>
                    </div>

                    {/* Chat Stream */}
                    <div className="flex-1 overflow-y-auto p-4 no-scrollbar">
                        <div className="max-w-3xl mx-auto pb-20">
                            {messages.map(msg => <ChatMessage key={msg.id} msg={msg} />)}
                            {loading && (
                                <div className="flex items-center gap-2 text-sky-600 p-2 animate-pulse">
                                    <Icons.Sparkles /> <span className="text-xs font-bold uppercase tracking-widest">Thinking...</span>
                                </div>
                            )}
                            <div ref={bottomRef}></div>
                        </div>
                    </div>

                    {/* Input Bar */}
                    <div className="p-4 fixed bottom-0 left-0 right-0 bg-gradient-to-t from-[#fdfcfb] via-[#fdfcfb] to-transparent z-10">
                        <div className="max-w-3xl mx-auto glass p-1.5 rounded-full border border-white shadow-xl flex items-center gap-2">
                            <input 
                                className="flex-1 bg-transparent px-5 py-3 outline-none text-slate-800 placeholder-slate-400 font-medium"
                                placeholder={`Ask about ${locality}...`}
                                value={input}
                                onChange={e => setInput(e.target.value)}
                                onKeyDown={e => e.key === 'Enter' && handleSend()}
                                disabled={loading}
                            />
                            <button 
                                onClick={handleSend}
                                disabled={!input.trim() || loading}
                                className={`w-10 h-10 rounded-full flex items-center justify-center transition-all ${
                                    input.trim() ? 'bg-slate-900 text-white shadow-lg transform active:scale-95' : 'bg-slate-100 text-slate-300'
                                }`}
                            >
                                <Icons.Send />
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>