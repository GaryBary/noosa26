<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#0f172a">
    <title>Noosa Guru | Regional Expert</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&family=Playfair+Display:ital,wght@0,400;0,600;0,700;1,400&display=swap" rel="stylesheet">
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
      :root { --noosa-blue: #0ea5e9; --noosa-navy: #0f172a; --noosa-sand: #fdfcfb; }
      body { font-family: 'Outfit', sans-serif; background-color: var(--noosa-sand); color: var(--noosa-navy); margin: 0; padding: 0; overflow: hidden; -webkit-tap-highlight-color: transparent; }
      #root { height: 100vh; display: flex; flex-direction: column; }
      .no-scrollbar::-webkit-scrollbar { display: none; }
      .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
      .glass { background: rgba(255, 255, 255, 0.85); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border-bottom: 1px solid rgba(255,255,255,0.5); }
      @keyframes message-enter { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
      .message-enter { animation: message-enter 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
      .input-glass { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(24px); -webkit-backdrop-filter: blur(24px); border: 1px solid rgba(255, 255, 255, 0.8); box-shadow: 0 8px 32px rgba(15, 23, 42, 0.12); }
    </style>
<script type="importmap">
{
  "imports": {
    "@google/genai": "https://esm.sh/@google/genai@^1.34.0",
    "react": "https://esm.sh/react@^19.2.3",
    "lucide-react": "https://esm.sh/lucide-react@^0.562.0",
    "react/": "https://esm.sh/react@^19.2.3/"
  }
}
</script>
</head>
<body>
    <div id="root">
        <div class="flex-1 flex flex-col items-center justify-center p-6 text-center bg-[#fdfcfb]">
             <div class="w-16 h-16 bg-slate-900 rounded-[1.5rem] flex items-center justify-center text-white shadow-xl mb-6">
                <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><polygon points="16.24 7.76 14.12 14.12 7.76 16.24 9.88 9.88 16.24 7.76"></polygon></svg>
             </div>
             <h2 style="font-family: 'Playfair Display', serif;" class="text-2xl font-bold text-slate-900 mb-2">Noosa Guru</h2>
             <p class="text-slate-400 text-[10px] font-bold uppercase tracking-[0.3em] animate-pulse">Initializing Coastal Intelligence...</p>
        </div>
    </div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useRef } from 'https://esm.sh/react@18.2.0';
        import { createRoot } from 'https://esm.sh/react-dom@18.2.0/client';
        import { GoogleGenAI } from 'https://esm.sh/@google/genai@latest';

        const Icons = {
            Compass: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><polygon points="16.24 7.76 14.12 14.12 7.76 16.24 9.88 9.88 16.24 7.76"/></svg>,
            User: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>,
            Send: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>,
            ExternalLink: () => <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" y1="14" x2="21" y2="3"/></svg>,
            Sparkles: () => <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"/></svg>,
            Refresh: () => <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21.5 2v6h-6"/><path d="M21.34 15.57a10 10 0 1 1-.57-8.38"/></svg>,
            Lock: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>
        };

        const SYSTEM_PROMPT = `You are the "Noosa Guru," an elite local expert for Noosa, QLD.
        Expertise Areas: Hastings Street, Noosa Junction, Noosaville, Sunshine Beach, Hinterland.
        
        RULES:
        1. BE ADAPTIVE: If the user just greets you (e.g., "hey", "hi"), greet them back warmly and wait for their request. Do not provide recommendations yet.
        2. BE CURRENT: If asked "how is it" or "how are things", use Google Search to find TODAY'S weather, surf conditions, or major events in Noosa.
        3. BE CONCISE: Max 3 recommendations when asked. Use a sophisticated, knowledgeable tone.
        4. RESPONSE FORMAT: **Venue Name**: One-sentence local insight.
        5. TOOLS: Always use googleSearch to ensure accuracy of links and status.
        6. NO HALLUCINATIONS: If you don't know a current status, say you're checking with the local network.
        `;

        const App = () => {
            const [messages, setMessages] = useState([{ id: 'welcome', role: 'model', text: "Welcome to Noosa. ðŸŒŠ I'm your guru on the coast. How can I help you discover the region today?" }]);
            const [input, setInput] = useState('');
            const [loading, setLoading] = useState(false);
            const [locality, setLocality] = useState('ALL NOOSA');
            const [isKeyReady, setIsKeyReady] = useState(false);
            
            const bottomRef = useRef(null);

            useEffect(() => {
                const checkApiKey = async () => {
                    if (window.aistudio) {
                        const hasKey = await window.aistudio.hasSelectedApiKey();
                        setIsKeyReady(hasKey);
                    } else if (process.env.API_KEY) {
                        setIsKeyReady(true);
                    }
                };
                checkApiKey();
            }, []);

            useEffect(() => { 
                const timer = setTimeout(() => {
                    bottomRef.current?.scrollIntoView({ behavior: 'smooth' });
                }, 100);
                return () => clearTimeout(timer);
            }, [messages, loading]);

            const handleConnect = async () => {
                if (window.aistudio) {
                    await window.aistudio.openSelectKey();
                    setIsKeyReady(true);
                }
            };

            const generateResponse = async (prompt, history, locality) => {
                const ai = new GoogleGenAI({ apiKey: process.env.API_KEY });
                const contents = history.map(msg => ({
                    role: msg.role === 'user' ? 'user' : 'model',
                    parts: [{ text: msg.text }]
                }));
                
                const userText = locality !== 'ALL NOOSA' ? `[Context: ${locality}] ${prompt}` : prompt;
                contents.push({ role: 'user', parts: [{ text: userText }] });

                return await ai.models.generateContent({
                    model: 'gemini-3-flash-preview',
                    contents: contents,
                    config: {
                        systemInstruction: SYSTEM_PROMPT,
                        temperature: 0.2,
                        tools: [{ googleSearch: {} }]
                    }
                });
            };

            const handleSend = async (txt) => {
                if (!txt.trim() || loading) return;
                setLoading(true);
                const currentHistory = [...messages];
                setMessages(prev => [...prev, { id: Date.now(), role: 'user', text: txt }]);
                setInput('');
                
                try {
                    const result = await generateResponse(txt, currentHistory, locality);
                    setMessages(prev => [...prev, { 
                        id: Date.now() + 1, 
                        role: 'model', 
                        text: result.text, 
                        chunks: result.candidates?.[0]?.groundingMetadata?.groundingChunks || []
                    }]);
                } catch (error) {
                    console.error("Guru Error:", error);
                    const errorMsg = error.message?.toLowerCase() || "";
                    if (errorMsg.includes("not found") || errorMsg.includes("403") || errorMsg.includes("api_key")) {
                        setIsKeyReady(false);
                        setMessages(prev => [...prev, { id: Date.now() + 1, role: 'model', text: "Access expired or Noosa network disconnected. Please re-connect to continue." }]);
                    } else {
                        setMessages(prev => [...prev, { id: Date.now() + 1, role: 'model', text: "I'm having trouble reaching the Noosa network. Let's try that again." }]);
                    }
                } finally {
                    setLoading(false);
                }
            };

            const ChatMessage = ({ msg }) => {
                const isUser = msg.role === 'user';
                const links = (msg.chunks || []).reduce((acc, chunk) => {
                    const uri = chunk.web?.uri;
                    const title = chunk.web?.title;
                    if (uri && title && !acc.some(l => l.uri === uri)) acc.push({ uri, title });
                    return acc;
                }, []).slice(0, 4);

                const renderText = (text) => text.split('\n').map((line, i) => {
                    const parts = line.split(/(\*\*.*?\*\*)/g);
                    return (
                        <div key={i} className="mb-1.5 last:mb-0">
                            {parts.map((part, j) => part.startsWith('**') ? <strong key={j} className="text-slate-900 font-bold">{part.slice(2, -2)}</strong> : part)}
                        </div>
                    );
                });

                return (
                    <div className={`flex w-full mb-6 message-enter ${isUser ? 'justify-end' : 'justify-start'}`}>
                        <div className={`flex max-w-[95%] md:max-w-[80%] gap-4 ${isUser ? 'flex-row-reverse' : 'flex-row'}`}>
                            <div className={`flex-shrink-0 w-9 h-9 rounded-2xl flex items-center justify-center shadow-lg ${isUser ? 'bg-slate-800 text-white' : 'bg-sky-500 text-white'}`}>
                                {isUser ? <Icons.User /> : <Icons.Compass />}
                            </div>
                            <div className="flex flex-col min-w-0">
                                <div className={`px-6 py-4 rounded-[1.8rem] shadow-sm text-sm md:text-base leading-relaxed ${isUser ? 'bg-slate-900 text-slate-50 rounded-tr-none' : 'glass text-slate-800 rounded-tl-none border border-white'}`}>
                                    {renderText(msg.text)}
                                </div>
                                {!isUser && links.length > 0 && (
                                    <div className="mt-3 flex flex-wrap gap-2">
                                        {links.map((link, idx) => (
                                            <a key={idx} href={link.uri} target="_blank" className="flex items-center gap-2 px-4 py-2 bg-white rounded-full text-[10px] font-bold text-slate-700 shadow-sm border border-slate-100 hover:bg-sky-50 hover:border-sky-200 transition-all no-underline">
                                                {link.title} <Icons.ExternalLink />
                                            </a>
                                        ))}
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>
                );
            };

            const localities = ['ALL NOOSA', 'HASTINGS ST', 'NOOSA JUNCTION', 'NOOSAVILLE', 'SUNSHINE BEACH', 'HINTERLAND'];

            return (
                <div className="flex flex-col h-screen bg-[#fdfcfb]">
                    <div className="glass sticky top-0 z-20 px-4 py-4 md:py-6 shadow-sm border-b border-slate-200/50">
                        <div className="max-w-4xl mx-auto">
                            <div className="flex items-center justify-between gap-4 mb-4">
                                <div className="flex items-center gap-3">
                                    <div className="w-12 h-12 bg-slate-900 rounded-2xl flex items-center justify-center text-white shadow-xl">
                                        <Icons.Compass />
                                    </div>
                                    <div>
                                        <h1 className="font-serif text-xl md:text-2xl font-bold text-slate-900 leading-none">Noosa Guru</h1>
                                        <p className="text-[10px] md:text-[11px] font-bold uppercase tracking-[0.2em] text-sky-600 mt-1.5">Regional Expert</p>
                                    </div>
                                </div>
                                <button onClick={() => setMessages([{ id: Date.now(), role: 'model', text: "Ready for a fresh start. What's on your mind today?" }])} className="p-2.5 text-slate-400 hover:text-slate-900 hover:bg-slate-100 rounded-full transition-all">
                                    <Icons.Refresh />
                                </button>
                            </div>
                            <div className="flex gap-2 overflow-x-auto no-scrollbar py-1">
                                {localities.map(loc => (
                                    <button key={loc} onClick={() => setLocality(loc)} className={`flex-shrink-0 px-4 py-2 rounded-full text-[10px] font-bold uppercase tracking-wider transition-all border ${locality === loc ? 'bg-slate-900 text-white border-slate-900 shadow-lg' : 'bg-white text-slate-500 border-slate-200 hover:border-slate-300'}`}>
                                        {loc}
                                    </button>
                                ))}
                            </div>
                        </div>
                    </div>

                    <div className="flex-1 overflow-y-auto px-4 py-8 no-scrollbar">
                        <div className="max-w-4xl mx-auto pb-40">
                            {messages.map(msg => <ChatMessage key={msg.id} msg={msg} />)}
                            {loading && (
                                <div className="flex items-center gap-3 text-sky-600 p-2 animate-pulse font-bold text-xs uppercase tracking-widest">
                                    <Icons.Sparkles /> Tuning into Noosa frequency...
                                </div>
                            )}
                            <div ref={bottomRef} className="h-4"></div>
                        </div>
                    </div>

                    <div className="p-4 fixed bottom-0 left-0 right-0 bg-gradient-to-t from-[#fdfcfb] via-[#fdfcfb] to-transparent z-10">
                        <div className="max-w-4xl mx-auto">
                            {!isKeyReady ? (
                                <button onClick={handleConnect} className="w-full input-glass p-6 rounded-3xl flex items-center justify-center gap-4 text-sky-700 font-bold hover:bg-sky-50 transition-all shadow-xl group">
                                    <div className="w-10 h-10 bg-sky-600 text-white rounded-xl flex items-center justify-center group-hover:scale-110 transition-transform"><Icons.Lock /></div>
                                    <div className="text-left">
                                        <p className="leading-tight">Connect Local Intelligence</p>
                                        <p className="text-[10px] font-normal opacity-70 italic">Restoring secure regional access...</p>
                                    </div>
                                </button>
                            ) : (
                                <div className="input-glass p-2 rounded-[2.5rem] flex items-center gap-2">
                                    <input className="flex-1 bg-transparent px-6 py-4 outline-none text-slate-800 placeholder-slate-400 font-medium md:text-lg" placeholder={`Ask about ${locality.toLowerCase()}...`} value={input} onChange={e => setInput(e.target.value)} onKeyDown={e => e.key === 'Enter' && handleSend(input)} disabled={loading} />
                                    <button onClick={() => handleSend(input)} disabled={!input.trim() || loading} className={`w-12 h-12 md:w-14 md:h-14 rounded-full flex items-center justify-center transition-all ${input.trim() && !loading ? 'bg-slate-900 text-white shadow-xl hover:scale-105 active:scale-95' : 'bg-slate-50 text-slate-200'}`}>
                                        <Icons.Send />
                                    </button>
                                </div>
                            )}
                            <p className="text-center text-[9px] text-slate-400 mt-4 uppercase tracking-[0.2em] font-medium">Noosa Regional Intel | Powered by Flash 3</p>
                        </div>
                    </div>
                </div>
            );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>